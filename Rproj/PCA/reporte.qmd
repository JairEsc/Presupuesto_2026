---
title: "PCA indicadores relacionados a problemas municipales"
author: "JairES"
editor: visual
format: 
  html:
    toc: true
    page-layout: full
lightbox: true
---

# Reporte PCA

## Selección de variables

```{r}
#| echo: false
#| message: false
#| warning: false
#| include: false
source("../Codigos/pre-procesamiento.R")
```

De una selección de más de 200 variables identificadas por su relación con problemáticas sociales y economómicas a nivel municipal, se hace un corte a 37 variables que se describen en la siguiente tabla.

```{r}
#| echo: false
#| message: false
#| warning: false

library(DT)
DT::datatable(diccionario_variables)
```

De éstas variables preliminares, se considerarán aquellas que conserven una correlación a pares no mayor a 0.8. Para ello, calculamos la matriz de correlaciones que se visualiza en la siguiente gráfica (da click para ver en grande).

### Exploramos las correlaciones entre las variables consideradas

```{r}
#| echo: false
#| message: false
#| warning: false
#| fig-width: 16
#| fig-height: 7
library(ggcorrplot)
ggcorrplot::ggcorrplot(corr = round(cor(indicadores[,-1]),2),type = "lower",show.diag = F,lab = T,lab_size = 1.4,title = "Correlación. Da click para ver en grande")
```

Se nota altas correlaciones en grupos de variables que pueden o no compartir temas. Por ejemplo, los grupos de variables dados por

-   *Índice de ingresos*,

-   *Porcentaje de la Población con ingreso inferior a la línea de Pobreza por Ingresos*

-   Índice de marginación

-   Porcentaje de la población de 15 años y más con educación básica incompleta

-   Porcentaje de viviendas que no disponen de internet

Dado que todas ellas están involucradas en el cálculo de la marginación, la consideramos una medida resumen y la conservamos.

Otro ejemplo de grupos de variables que comparten alta correlación se da en

-   Porcentaje de población desocupada

-   Puestas a disposición realizadas por el personal de la institución encargada de la función de seguridad pública, por municipio o demarcación territorial según tipo

-   Porcentaje de PIB con respecto al total estatal

-   Total de delitos del fuero comun

En este caso, la contribución al PIB estatal y población desocupada están relacionadas al tema de Economía y se calcula una correlación de 0.82, por lo que se conserva *Porcentaje de PIB con respecto al total estatal.*

Por otro lado, la variable *Puestas a disposición realizadas por el personal de la institución encargada de la función de seguridad pública, por municipio o demarcación territorial según tipo* está correlacionada al número de delitos, es decir, con *Total de delitos del fuero comun.* En este caso, conservamos la segunda por su más sencilla interpretación.

## Análisis de Componente Principales de variables conservadas

```{r}
#| echo: false

source("../../Rproj/Codigos/post_seleccion_vars.R")
pca_indicadores_post=prcomp(indicadores[,-1], scale = TRUE,retx = T)

```

Generamos una gráfica tipo "elbow" para la visualización de la explicación de la varianza por componente.

```{r}
#| echo: false
var_explicada <- pca_indicadores_post$sdev^2
# Calculamos el porcentaje de varianza
proporcion_varianza <- var_explicada / sum(var_explicada)

# Creamos el data frame para la visualización
data_varianza <- data.frame(
  PC = 1:length(proporcion_varianza),
  Varianza = proporcion_varianza
)

library(ggplot2)
ggplot(data_varianza, aes(x = PC, y = Varianza)) +
  geom_bar(stat = "identity", fill = "#F5DABC") +
  geom_text(aes(label = paste0(round(Varianza * 100), "%")),
            vjust = -0.5, size = 3) +
  labs(x = "Componente Principal", y = "Proporción de Varianza Explicada") +
  theme_minimal() +
  ggtitle("Varianza Explicada por Componente Principal")
```

De esta gráfica nos podemos interesar en los primeros 4 componentes que aportan a más de la mitad de la varianza explicada y que se detallan a continuación.

### Contribuciones a los principales componentes.

Para una exploración visual de los principales (2) componentes, podemos considerar una gráfica de las contribuciones a la composición de éstos

```{r}
#| echo: false
#| message: false
#| warning: false
#| layout-ncol: 2
#| fig-cap: "Contribución de las variables utilizadas para la composición de los primeros dos componentes"
library(factoextra)
# Gráfico 1: Todas las variables
factoextra::fviz_pca_var(pca_indicadores_post,
                         axes = 1:2,
                         fill.var = "contrib",
                         alpha.var = "contrib",
                         col.var = "contrib",
                         gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                         repel = TRUE)


```

Naturalmente, la visualización de +30 variables puede complicarse al tratar de reducirla a dos componentes, por lo que se consideran también los componentes 3 y 4, además de aplicar un filtro a las principales 10 contribuciones de cada par de componentes.

```{r}
#| echo: false
#| layout-ncol: 2
#| fig-cap: "Principales diez componentes en la composición de los componentes 1-4"
# Gráfico 2: Solo las 10 variables principales
factoextra::fviz_pca_var(pca_indicadores_post,
                         axes = 1:2,
                         fill.var = "contrib",
                         alpha.var = "contrib",
                         col.var = "contrib",
                         gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                         repel = TRUE,
                         select.var = list(contrib = 10))
# Gráfico 2: Solo las 10 variables principales
factoextra::fviz_pca_var(pca_indicadores_post,
                         axes = 3:4,
                         fill.var = "contrib",
                         alpha.var = "contrib",
                         col.var = "contrib",
                         gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
                         repel = TRUE,
                         select.var = list(contrib = 10))

```

#### Composición del Componente 1

Tomando los primeros 2 pesos según su distribución en valor absoluto, podemos notar que las variables que más aportan al primer componente son:

-   Índice de marginación (+)

-   Tiendas Liconsa (-)

-   Viviendas particulares habitadas que no tienen drenaje. (-)

-   Total de delitos del fuero común (+)

-   Porcentaje de población de 12 años y más pensionadas o jubiladas, estudiantes, dedicadas a los quehaceres del hogar; o que tienen alguna limitación física o mental permanente que les impide trabajar. (+)

-   Porcentaje de personas sin derecho a servicios de salud. (+)

-   Porcentaje de personas con Carencia por Acceso a los Servicios Básicos de la Vivienda. (-)

-   Personas con mucha dificultad para caminar o moverse, subir o bajar. (-)

De lo anterior se puede renombrar al primer componente como una medida de *Marginación.*

#### Composición del Componente 2

Tomando los primeros 7 pesos según su distribución en valor absoluto, podemos notar que las variables que más aportan al primer componente son:

-   Porcentaje de la Población con Carencia por Acceso a la Alimentación

-   Personal destinado a funciones de seguridad pública muncipal

-   Total de lámparas y/o luminarias del servicio de alumbrado público.

-   Número de personas con Carencia por Acceso a los Servicios Básicos en la Vivienda

-   Personas con mucha dificultad para caminar o moverse, subir o bajar.

-   Incidencia de enfermedades intestinales por cada 1000 habitantes

-   Inversión total en carreteras y vialidades en 3 años

De lo anterior se puede renombrar al segundo componente como una medida de: Seguridad y vulnerabilidad.

#### Composición del Componente 3

Tomando los primeros 7 pesos según su distribución en valor absoluto, podemos notar que las variables que más aportan al primer componente son:

-   Porcentaje de PIB con respecto al total estatal

-   Porcentaje de superficie agrícola siniestrada a nivel municipal

-   Total de lámparas y/o luminarias del servicio de alumbrado público.

-   Coheficiente GINI Cohesión Social

-   inversión total en espacio público y educativo en 3 años

-   Total de delitos del fuero comun

-   Porcentaje de aguas residuales sin tratar por municipio

De lo anterior se puede renombrar al tercer componente como una medida de Desigualdad.

#### Composición del Componente 4

Tomando los primeros 4 pesos según su distribución en valor absoluto, podemos notar que las variables que más aportan al primer componente son:

-   Kilómetros de carretera / total del territorio

-   Unidades económicas de manufactura de más de 50 personas

-   Metros cuadrados de áreas verdes urbanas por habitante

-   tasa de crecimiento de las unidades económicas en los ultimos 15 años

De lo anterior se puede renombrar al cuarto componente como una medida de Infraestructura.

## Proyección sobre componentes a nivel municipal.

Se calcula la proyección de los datos sobre los principales 4 componentes, obteniendo una observación de cada municipio en las medidas descritas.

```{r}
#| echo: false

proyeccion=pca_indicadores_post$x |> as.data.frame() |> 
  dplyr::mutate(NOM_MUN=indicadores$NOM_MUN) |> 
  dplyr::relocate(NOM_MUN,.before = PC1) |> 
  dplyr::select(NOM_MUN:PC4) |> 
  dplyr::rename('Marginación'=PC1) |> 
  dplyr::rename('Seguridad y vulnerabilidad'=PC2) |> 
  dplyr::rename('Desigualdad'=PC3) |> 
  dplyr::rename('Infraestructura'=PC4) 
datatable(proyeccion)
```

Es importante mencionar que los pesos de los componentes tienen dirección (positiva o negativa) dependiendo de su signo, de manera que para establecer un orden entre municipios o entre temas para un mismo municipio, se sugiere medir la distancia a la media de otros municipios y el valor del indicador definido como medida a partir de los componentes.
