---
title: "Documentación Análisis de Pertinencia de Obras"
author: "Jair"
format: 
  html:
    toc: true
    page-layout: full
    other-links:
      - text: App - Índice de Pertinencia (Obras)
        href: https://jaires-analisis-obras-indice-pertinencia.share.connect.posit.cloud/
editor: visual
lightbox: true
bibliography: references.bib  
---

## Lista de consideraciones

-   Accesibilidad carretera a cabeceras municipales (@hickman2024rural)

    -   Pendiente

    -   Uso de suelo

    -   Red vial y velocidades máximas permitidas

-   Distancia a Escuelas (@meena2023evaluation)

-   Distancia a Centros de Trabajo (@duran2014road)

-   Distancia a Hospitales (@lopes2021mcda)

-   Áreas Naturales Protegidas (Distancia)

-   Zonas Prioritarias (Distancia) (@brichetti2021infrastructure)

-   Secciones Electorales (Prioritarias)

-   Nivel de uso

-   Distancia a localidades Marginadas (Alta y Muy alta) (@brocker2010assessing)

-   Distancia a localidades con bajo acceso a agua entubada (@nicoletti2023disadvantaged)

-   Distancia a localidades con bajo acceso a drenaje sanitario (@nicoletti2023disadvantaged)

-   Percepción pública a partir de encuesta de aprobación georeferenciada

## Preprocesamiento y exploración

Se definen rasters

```{r}
#| echo: false
#| message: false
#| warning: false
#| include: true
library(raster)
library(viridis)
library(htmlwidgets)
library(slickR)
source("Códigos/leer_rasters_generados_en_r.R")
rasters=list.files("Inputs/Rasters_Generados_en_R/rasters_app/",full.names = T) |> lapply(raster)##Definimos rasters del caso base
rasters_agua=list.files("Inputs/Rasters_Generados_en_R/rasters_app_agua/",full.names = T) |> lapply(raster)#Otro tema
rasters_drenaje=list.files("Inputs/Rasters_Generados_en_R/rasters_app_drenaje/",full.names = T) |> lapply(raster)#Otro tema
rasters_Espacios_publicos=list.files("Inputs/Rasters_Generados_en_R/rasters_app_espacios_publicos/",full.names = T) |> lapply(raster)#Otro tema
rasters_salud=list.files("Inputs/Rasters_Generados_en_R/rasters_app_salud/",full.names = T) |> lapply(raster)#Otro tema
rasters_educacion=list.files("Inputs/Rasters_Generados_en_R/rasters_app_educacion/",full.names = T) |> lapply(raster)#Otro tema
rasters_full=c(rasters[c(1:7,9,10)],rasters_agua[1:2],rasters_drenaje[1:2],rasters_Espacios_publicos[[1]],rasters_salud[[1]],rasters_educacion[[1]])
rasters_list_names_full=c(rasters_list_names[c(1:7,9,10)],
                          "Distancia a localidades con bajo acceso a agua entubada","Percepción suministro de agua",
                          "Distancia a localidades con bajo acceso a drenaje sanitario","Percepción infraestructura de drenaje",
                   "Percepción de Espacios Públicos","Percepción Infraestructura Educativa",   "Percepción Infraestructura Salud"    )

rasters_full[[3]]=-rasters_full[[3]]
values(rasters_full[[13]])[1]=maxValue(abs(rasters_full[[13]]))
raster_plots <- list()
  for (i in 1:length(rasters_full)){
    # Crear un archivo PNG temporal para cada gráfico
    temp_file <- tempfile(fileext = ".png")
    png(temp_file, width = 600, height = 400)
    plot(rasters_full[[i]],
         col = viridis(256),
         legend = TRUE,main=rasters_list_names_full[i])
    dev.off()
    raster_plots[[i]] <- temp_file
  }
slickR(raster_plots,width = "90%")+ 
  settings(
    dots = TRUE
  )
```

Agregamos un widget para la exploración de algunos de los rasters utilizados y obras de tipo línea y punto

```{r}
#| include: false
#| warning: false
#| message: false
library(sf)
source("Códigos/leer_obras_sipdus_carretera_y_separar_por_tipo_geometria.R")
```

```{r}
#| include: false
#| echo: false
#| message: false
#| warning: false

#library(crosstalk)
library(leaflet)
library(DT)

```

```{r}
#| include: true
#| echo: false
#| message: false
#| warning: false
library(leaflegend)
leaflet() |> addTiles(options = leaflet::tileOptions(opacity = 1)) |>
  addRasterImage(rasters_full[[1]],opacity = 0.25,group = rasters_list_names_full[[1]]) |>
  addRasterImage(rasters_full[[2]],opacity = 0.25,group = rasters_list_names_full[[2]]) |>
  addRasterImage(rasters_full[[3]],opacity = 0.25,group = rasters_list_names_full[[3]]) |>
  addRasterImage(rasters_full[[4]],opacity = 0.25,group = rasters_list_names_full[[4]]) |>
  addRasterImage(rasters_full[[5]],opacity = 0.25,group = rasters_list_names_full[[5]]) |>
  addRasterImage(rasters_full[[6]],opacity = 0.25,group = rasters_list_names_full[[6]]) |>
  addRasterImage(rasters_full[[7]],opacity = 0.25,group = rasters_list_names_full[[7]]) |>
  addRasterImage(rasters_full[[8]],opacity = 0.25,group = rasters_list_names_full[[8]]) |>
  addRasterImage(rasters_full[[9]],opacity = 0.25,group = rasters_list_names_full[[9]]) |>
  addRasterImage(rasters_full[[10]],opacity = 0.25,group = rasters_list_names_full[[10]]) |>
  addRasterImage(rasters_full[[11]],opacity = 0.25,group = rasters_list_names_full[[11]]) |>
  addRasterImage(rasters_full[[12]],opacity = 0.25,group = rasters_list_names_full[[12]]) |>
  addRasterImage(rasters_full[[13]],opacity = 0.25,group = rasters_list_names_full[[13]]) |>
  addRasterImage(rasters_full[[14]],opacity = 0.25,group = rasters_list_names_full[[14]]) |>
  addRasterImage(rasters_full[[15]],opacity = 0.25,group = rasters_list_names_full[[15]]) |>
  addRasterImage(rasters_full[[16]],opacity = 0.25,group = rasters_list_names_full[[16]]) |> 
# |> 
#   
#   # addMarkers(data=obras_sipdus_carretera_punto,group = "Obras_tipo_punto",
#   #            label = obras_sipdus_carretera_punto$Obra) |>
#   addMarkers(data=obras_sipdus_punto,group = "Obras_tipo_multipunto",
#              label = obras_sipdus_punto$Obra) 

  addLayersControl(overlayGroups = rasters_list_names_full) |> addLegendNumeric( pal = colorNumeric('Spectral', 1:100) , values = 1:100, position = 'bottomright', title = 'Valores de rasters', orientation = 'horizontal', shape = 'rect', decreasing = FALSE, height = 20, width = 120,labels = '',tickLength = 0) |> 
  hideGroup(group = rasters_list_names_full[2:16])
```

```{r}
#| echo: false
library(DT)
datatable(obras_sipdus|> 
            dplyr::select(ID_OBRA, Municipio, Rubro, Ejercicio, Inversión, Habitantes.beneficiados, Ejecutora, Obra) |> 
            st_drop_geometry()|>dplyr::rename(Obra_breve_Descripcion=Obra) |> 
            dplyr::rename(Habitantes_beneficiados=Habitantes.beneficiados), 
          options = list(
            pageLength = 5,
            rownames = FALSE,
            columnDefs = list(list(width = '400px', targets = c(7))),
            scrollX = TRUE,
            stripeClasses = c('even', 'odd')
          ),
          filter = "top")

```

De todas maneras, aún debemos establecer la interpretación de cada raster, hacer un escalamiento apropiado y definir los pesos de cada criterio que definirán la pertinencia de obras.

```{r}
#| echo: false
#| message: false
#| warning: false
#| include: false
library(raster)
library(viridis)
library(htmlwidgets)
library(slickR)
descripciones_list_full=rasters_list_names_full |> as.list()
descripciones_list_full=paste0(descripciones_list_full,"-------")
descripciones_minimas=c(
  "Se mide en distancia. Mayor valor significa más pertinente la obra",
  "Se mide en distancia. Menor distancia a centros de trabajo significa más pertinente la obra",
  "Se mide en distancia. Mayor distancia una ANP significa más pertinente la obra",
  "Se mide en distancia. Menor distancia a escuelas significa más pertinente la obra",
  "Se mide en distancia. Menor distancia a hospitales significa más pertinente la obra",
  "Se mide en log-distancia. Menor distancia a localidades marginadas significa más pertinente la obra",
  "Se mide en log-distancia. Menor valor significa obra específica de una ZAP. I.e. más pertinente la obra",
  "Se mide en log-distancia. Menor distancia significa obra específica de una localidad sin servicios públicos I.e. más pertinente la obra",
  "Se mide en porcentaje de votos. Mayor valor significa más votos al partido",
  "Se mide en percepción. Menor valor (percepción negativa) significa más pertinente la obra"
)
descripciones_minimas=descripciones_minimas[c(1:7,9,10)]

descripciones_list_full[[1]]=paste0(descripciones_list_full[[1]],descripciones_minimas[1])
descripciones_list_full[[2]]=paste0(descripciones_list_full[[2]],descripciones_minimas[2])
descripciones_list_full[[3]]=paste0(descripciones_list_full[[3]],descripciones_minimas[3])
descripciones_list_full[[4]]=paste0(descripciones_list_full[[4]],descripciones_minimas[4])
descripciones_list_full[[5]]=paste0(descripciones_list_full[[5]],descripciones_minimas[5])
descripciones_list_full[[6]]=paste0(descripciones_list_full[[6]],descripciones_minimas[6])
descripciones_list_full[[7]]=paste0(descripciones_list_full[[7]],descripciones_minimas[7])
descripciones_list_full[[8]]=paste0(descripciones_list_full[[8]],descripciones_minimas[8])
descripciones_list_full[[9]]=paste0(descripciones_list_full[[9]],descripciones_minimas[9])
#agua
descripciones_list_full[[10]]=paste0(descripciones_list_full[[10]],"Se mide en log-distancia. Menor distancia significa obra específica de una localidad sin acceso a agua entubada. I.e. más pertinente la obra")
descripciones_list_full[[11]]=paste0(descripciones_list_full[[11]],"Se mide en percepción. Menor valor (percepción negativa) significa más pertinente la obra")
#drenaje
descripciones_list_full[[12]]=paste0(descripciones_list_full[[12]],"Se mide en log-distancia. Menor distancia significa obra específica de una localidad sin acceso a drenaje sanitario. I.e. más pertinente la obra")
descripciones_list_full[[13]]=paste0(descripciones_list_full[[13]],"Se mide en percepción. Menor valor (percepción negativa) significa más pertinente la obra")
#espacios publicos
descripciones_list_full[[14]]=paste0(descripciones_list_full[[14]],"Se mide en percepción. Menor valor (percepción negativa) significa más pertinente la obra")

#Educacion
descripciones_list_full[[15]]=paste0(descripciones_list_full[[15]],"Se mide en percepción. Menor valor (percepción negativa) significa más pertinente la obra")

#Salud
descripciones_list_full[[16]]=paste0(descripciones_list_full[[16]],"Se mide en percepción. Menor valor (percepción negativa) significa más pertinente la obra")


```

```{r}
#| echo: false
#| message: false
#| warning: false
#| include: true
#| out-height: "90vh"
#| out-width: "95vw"
library(raster)
library(viridis)
library(htmlwidgets)
library(slickR)
library(grid)
library(ggplot2)
raster_plots <- list()
for (i in 1:length(rasters_full)){
  temp_file <- tempfile(fileext = ".png")
  png(temp_file)
  plot(rasters_full[[i]], col = viridis(256), legend = TRUE, main = rasters_list_names_full[i])
  
  hist_plot <- ggplot(data.frame(x = getValues(rasters_full[[i]])), aes(x)) +
    geom_histogram(bins = 30, fill = viridis(1), color = "white") +
    theme_minimal() +
    labs(x = "", y = "") +
    theme(
      plot.background = element_rect(fill = "white", color = NA),
      panel.background = element_rect(fill = "white", color = NA)
    )
  
  vp <- viewport(width = 0.3, height = 0.3, x = 0, y = 0, just = c("left", "bottom"))
  print(hist_plot, vp = vp)
  dev.off()
  raster_plots[[i]] <- temp_file
}

slickR(raster_plots,height = "80vh",width = "90%")%synch%
( slickR(descripciones_list_full, slideType = 'p'))+
  settings(
    dots = TRUE,adaptiveHeight = T
  )
```

Podemos explorar algunas correlaciones entre los raster utilizados (da click a la imagen para ampliar)

```{r}
#| echo: false
#| message: false
#| warning: false
#| fig-width: 12
#| fig-height: 7
library(ggcorrplot)

rasters_by_cells <- rasters_full |> lapply(getValues)
rasters_by_cells=rasters_by_cells |> as.data.frame()
colnames(rasters_by_cells)=gsub("\n","",rasters_list_names_full)
cormat <- round(cor(rasters_by_cells,use = "na"),2)
#head(cormat)
ggcorrplot(cormat,lab = T,type = "lower",show.diag = F,lab_size = 2.2)

```

Y también visualizarlas por pares.

```{r}
#| echo: false

library(raster)
library(viridis)
library(htmltools)
library(slickR)

###Agregarlos en un div con display flex.
div(
  style = "display: flex;",
  div(
    style = "width: 47.5%;height:90%",
    slickR(raster_plots) +
      settings(dots = TRUE)
  ),
  div(
    style = "width: 47.5%;padding-left:5%;height:90%",
    slickR(raster_plots[c(2:length(raster_plots))]) +
      settings(dots = TRUE)
  )
)

```

Esta información se toma en cuenta al momento de definir los rankings en el método de las jerarquías analíticas.

# Criterios de Clasificación

Consideraremos 5 rubros de obras, para los cuales se utilizarán rasters específicos dependiendo del rubro. Por ejemplo, naturalmente usamos *percepción de infraestructura de salud* para el rubro de *Infraestructura de Salud.* Los rubros utilizados son:

## Infraestructura Vial

Definimos dos tipos de obra, ***Mejoramiento*** y ***Construcción.*** En la primera se agregan aquellas obras que consisten en remodelación, reconstrucción, repavimentación o mejoramiento de obras ya existentes.

### ***Mejoramiento***

Para la definición de la pertinencia de una obra ya existente se considerarán únicamente los criterios de Accesibilidad y una medida de uso definida a partir de datos de orígenes destino, los cuales están definidos únicamente para vialidades.

```{r}
#| echo: false
#| fig-align: center

###Agregarlos en un div con display flex.

par(mfrow=c(1,2))

plot(rasters_full[[1]],
col = viridis(256),
legend = TRUE,main=rasters_list_names_full[1])
 
plot("Inputs/Rasters_Generados_en_R/Otros/nivel_de_uso_proxy_de_numero_de_viajes.tif" |> raster(),
col = viridis(256),
legend = TRUE,main="Nivel de uso")

par(mfrow=c(1,1))
```

### Construcción

Para definir la pertinencia de una obra nueva, se utilizarán los criterios anteriormente enunciados, a partir del siguiente ranking.

-   <div>

    1.  Accesibilidad carretera a cabeceras municipales

    </div>

-   <div>

    2.  Distancia a localidades Marginadas (Alta y Muy alta)

    </div>

-   <div>

    3.  Zonas Prioritarias (Distancia)

    </div>

-   <div>

    4.  Distancia a localidades con bajo acceso a agua entubada y Distancia a localidades con bajo acceso a drenaje sanitario

    </div>

-   <div>

    5.  Distancia a Hospitales

    </div>

-   <div>

    6.  Distancia a Escuelas

    </div>

-   <div>

    7.  Distancia a Centros de Trabajo

    </div>

-   <div>

    8.  Áreas Naturales Protegidas (Distancia)

    </div>

-   <div>

    9.  Secciones Electorales (Prioritarias)

    </div>

-   <div>

    10. Percepción Infraestructura Vial

    </div>

## Infraestructura de Suministro de Agua

Se utilizarán rasters específicos del rubro:

-   Distancia a localidades con bajo acceso a agua entubada

-   Percepción suministro de agua

## Infraestructura de Drenaje

Se utilizarán rasters específicos del rubro:

-   Distancia a localidades con bajo acceso a drenaje sanitario

-   Percepción infraestructura de drenaje

## Infraestructura de Salud

Se utilizará raster específicos del rubro:

-   Percepción Infraestructura de Salud

## Infraestructura Educativa

Se utilizará raster específicos del rubro:

-   Percepción Infraestructura Educativa

## Espacios Públicos

Se utilizará raster específicos del rubro:

-   Percepción Espacios Públicos

# Clasificación

Antes de definir el índice de pertinencia removemos valores atípicos para cada raster basados en el criterio del rango intercuartil. Estos valores atípicos se reemplazan con los valores máximos o mínimos de los valores no atípicos, según sea el caso.

Además, dada la alta correlación entre distancia a localidades con bajo acceso a agua entubada y drenaje, se combinan en un solo raster dado por el mínimo entre ellos.

Con los rankings de criterios definimos una transformación lineal con los criterios y su interpretación

![Diagrama de generación de Índice de Pertinencia](Inputs/Rasters_Generados_en_R/Otros/diagram-20250903.png){fig-align="center" width="606"}

Incluimos una [aplicación Web](https://jaires-analisis-obras-indice-pertinencia.share.connect.posit.cloud/) que te permite definir los pesos de los rasters de cada tipo de obra.

[![App web](Inputs/Captura%20de%20pantalla%202025-09-04%20163747.png)](https://jaires-analisis-obras-indice-pertinencia.share.connect.posit.cloud/)

# Referencias
