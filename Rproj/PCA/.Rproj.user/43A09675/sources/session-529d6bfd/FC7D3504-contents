---
title: "Exploración encuesta de precepción"
lightbox: true
author: "Jair"
format: 
  html:
    page-layout: full
editor: visual
---

## Encuesta de percepción de aprobación

Utilizamos los datos de 2025 con las siguientes preguntas

-   Cuál.considera.que.es.el.principal.problema.que.enfrenta.el.estado.de.Hidalgo.
-   Y...cuál.considera.que.es.el.principal.problema.en.su.colonia."\
-   X.Ha.mejorado..se.ha.quedado.igual.o.ha.empeorado..Instalaciones.de.planteles.educativos."\
-   X.Ha.mejorado..se.ha.quedado.igual.o.ha.empeorado..Equipamiento.en.aulas."\
-   En.el.último.año...usted.se.vio.afectado.a.por.Falta.de.suministro.de.agua.en.la.vivienda."\
-   En.el.último.año...usted.se.vio.afectado.a.por.Invertir.mucho.tiempo.en.traslados.por.falta.de.carreteras."\
-   En.el.último.año...usted.se.vio.afectado.a.por.Caminos.sin.posibilidad.de.lograr.velocidad.por.estar.en.mal.estado."\
-   En.el.último.año...usted.se.vio.afectado.a.por.Falta.de.parques..jardines.o.lugares.de.esparcimiento.cerca.de.su.vivienda."
-   En.el.último.año...usted.se.vio.afectado.a.por.Deterioro.de.calles.y.avenidas.por.falta.de.mantenimiento."\
-   SALUD...En.el.último.año...usted.se.vio.afectado.a.por.Mal.equipamiento.en.las.instalaciones."

## Agrupamiento por temáticas

Únicamente las preguntas *"Cuál.considera.que.es.el.principal.problema.que.enfrenta.el.estado.de.Hidalgo"* y *"Y...cuál.considera.que.es.el.principal.problema.en.su.colonia."* tienen múltiples respuestas.

Por lo anterior, se consideran las posibles respuestas para su clasificación junto a otras preguntas de la misma temática.

### Infraestructura Educativa

-   X.Ha.mejorado..se.ha.quedado.igual.o.ha.empeorado..Instalaciones.de.planteles.educativos.

-   X.Ha.mejorado..se.ha.quedado.igual.o.ha.empeorado..Equipamiento.en.aulas.

### Salud

-   SALUD...En.el.último.año...usted.se.vio.afectado.a.por.Mal.equipamiento.en.las.instalaciones."

### Espacios Públicos

-   En.el.último.año...usted.se.vio.afectado.a.por.Falta.de.parques..jardines.o.lugares.de.esparcimiento.cerca.de.su.vivienda."

### Agua (Suministro)

-   En.el.último.año...usted.se.vio.afectado.a.por.Falta.de.suministro.de.agua.en.la.vivienda."

-   Cuál.considera.que.es.el.principal.problema.que.enfrenta.el.estado.de.Hidalgo. (Escasez de agua)

-   Y...cuál.considera.que.es.el.principal.problema.en.su.colonia.(Agua potable)

### Drenaje

-   Y...cuál.considera.que.es.el.principal.problema.en.su.colonia.(Drenaje)

-   Cuál.considera.que.es.el.principal.problema.que.enfrenta.el.estado.de.Hidalgo. (Drenaje)

### Infraestructura Vial

-   En el último año, ¿usted se vio afectado/a por Invertir mucho tiempo en traslados por falta de carreteras?

-   En el último año, ¿usted se vio afectado/a por Caminos sin posibilidad de lograr velocidad por estar en mal estado?

-   En el último año, ¿usted se vio afectado/a por Deterioro de calles y avenidas por falta de mantenimiento?

-   ¿Cuál considera que es el principal problema que enfrenta el estado de Hidalgo? (Infraestructura Vial)

-   Y, ¿cuál considera que es el principal problema en su colonia? (Infraestructura vial)

## Procesamiento y medida resumen

Para su uso, se genera un raster resumen que define la percepción de la infraestructura actual de cada tema. Por ejemplo, para **Infraestructura Educativa** ambas preguntas se responden con "Sí" o "No", por lo que para cada una, se filtra la encuesta según su respuesta y se calcula un kernel de densidad gaussiana con decaimiento a 1km, los cuales se combinan en un solo raster de percepción de infraestructura a partir de la diferencia de las medias (de las respuestas de percepción positiva - las respuestas de percepción negativa), siendo valores positivos una percepción positiva a la infraestructura actual y valores negativos a una percepción negativa. Los valores muy cercanos a cero se interpretan como incertidumbre o falta de datos, por lo que se omiten.

```{r}
#| echo: false
#| warning: false
#| message: false
library(raster)
library(terra)
library(sf)
library(leaflet)
library(leaflegend)

z="Inputs/Rasters_Generados_en_R/Otros/exploracion_encuesta/Por temas/Infraestructura educativa/diff_mejor_menos_peor.tif" |> raster()
z[abs(z)<1e-5]=NA
z2="Inputs/Rasters_Generados_en_R/Otros/exploracion_encuesta/Por temas/Salud/diff_no_afectado_menos_afectado.tif" |> raster()
z2[abs(z2)<1e-5]=NA
z3="Inputs/Rasters_Generados_en_R/Otros/exploracion_encuesta/Por temas/Espacios publicos/diff_no_afectado_menos_afectado.tif" |> raster()
z3[abs(z3)<1e-5]=NA
z4="Inputs/Rasters_Generados_en_R/Otros/exploracion_encuesta/Por temas/Agua suministro/resumen_agua_suministro.tif" |> raster()
z4[abs(z4)<1e-4]=NA
z5="Inputs/Rasters_Generados_en_R/Otros/exploracion_encuesta/Por temas/Drenaje/resumen_drenaje.tif" |> raster()
z5[abs(z5)<1e-4]=NA

# z5=-z5
# values(z5)[1]=maxValue(abs(z5))
z6="Inputs/Rasters_Generados_en_R/Otros/exploracion_encuesta/Por temas/Carreteras/infraestructura_percepcion_negativa.tif" |> raster()
z6[abs(z6)<1e-4]=NA

z6=-z6
values(z6)[1]=maxValue(abs(z6))

leaflet() |> addTiles()|> 
  addRasterImage(z2,opacity=0.4,group='Salud') |>
  addRasterImage(z3,opacity=0.4,group='Espacios Públicos') |>
  addRasterImage(z4,opacity=0.4,group='Agua (suministro)') |>
  addRasterImage(z5,opacity=0.4,group='Drenaje') |>
  addRasterImage(z6,opacity=0.4,group='Infraestructura Vial') |>
  addRasterImage(z,opacity=0.4,group='Infraestructura Educativa') |>
  
  addLegendNumeric( pal = colorNumeric('Spectral', 1:100) , values = 1:100, position = 'bottomright', title = 'Escala percepción (negativa - > positiva)', orientation = 'horizontal', shape = 'rect', decreasing = FALSE, height = 20,width = 300,labels = '',tickLength = 0) |> addLayersControl(overlayGroups = c('Salud','Espacios Públicos','Agua (suministro)','Drenaje','Infraestructura Vial','Infraestructura Educativa'
     ),options = layersControlOptions(collapsed = F)) |> hideGroup(c('Espacios Públicos','Agua (suministro)','Drenaje','Infraestructura Vial','Infraestructura Educativa'
     )) 
```

Además, agregamos la matriz de correlación entre los rasters resumen

```{r}
#| echo: false
#| message: false
#| warning: false
library(ggcorrplot)
library(raster)
z_lista=list(z,z2,z3,z4,z5,z6)
rasters_by_cells <- z_lista |> lapply(values)
rasters_by_cells=rasters_by_cells |> as.data.frame()
colnames(rasters_by_cells)=c('Infraestructura Educativa','Salud','Espacios Públicos','Agua (suministro)','Drenaje','Infraestructura Vial'
     )
cormat <- round(cor(rasters_by_cells,use = "na"),2)
#head(cormat)
ggcorrplot(cormat,lab = T,type = "lower",show.diag = F)
```
